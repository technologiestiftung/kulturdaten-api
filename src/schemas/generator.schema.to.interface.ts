import { writeFileSync } from 'fs'
import { compile,  JSONSchema  } from 'json-schema-to-typescript';
import { readFileSync } from 'fs';
import * as yaml from 'js-yaml';

async function generate() {

	generateInterface('Organization','organizations', 'organizations/models/organization');
	generateInterface('CreateOrganization','organizations', 'organizations/dtos/create.organization.dto');
	generateInterface('PatchOrganization','organizations', 'organizations/dtos/patch.organization.dto');

	generateInterface('User','users', 'users/models/user');
	generateInterface('CreateUser','users', 'users/dtos/create.user.dto');
	generateInterface('PatchUser','users', 'users/dtos/patch.user.dto');

	generateInterface('Event','events', 'events/models/event');

	generateInterface('Location','locations', 'locations/models/location');

	generateInterface('Auth','auth', 'auth/dtos/auth');
	generateInterface('Login','auth', 'auth/dtos/login');

	generateInterface('Health','health', 'health/dtos/health');

	generateInterface('NotFoundError','errors', 'common/errors/notFoundError');

	generateInterface('Text','common', 'common/interfaces/Text');
	generateInterface('Description','common', 'common/interfaces/Description');

}


async function generateInterface(className: string, schemaFile: string, targetFile: string) {
	
	const options = (baseFile: string) => {
		return {
			bannerComment: `/* eslint-disable */
		/**
		 * This file was automatically generated by json-schema-to-typescript.
		 * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file.
		 * 
		 * =>  @see ${baseFile}
		 * 
		 * and run "npm run schema-to-interface" to regenerate this file.
		 */
		`,
		additionalProperties: false,
		cwd: './src/schemas'
		}
	};
	const schemaPath = `./src/schemas/${schemaFile}/${className}.yml`;
	const schemaYaml = readFileSync(schemaPath, 'utf8');
	const schemaObject = yaml.load(schemaYaml) as JSONSchema;
	const targetType = await compile(schemaObject, className, options(schemaPath));
	const targetPath = `./src/${targetFile}.generated.ts`;

	writeFileSync(targetPath, targetType);
}

generate();